#!/bin/bash

CLEAN='true'

if [[ $1 ]]; then
    if [[ "$1" == '-n' ]]; then
        CLEAN=''
    fi
fi

BASE_DIR="$HOME/Dev/BST/defenseos"
cd "$BASE_DIR"
WORK_DIR="$BASE_DIR"

shellexec ()
{
    tmpfile=$(mktemp)
    echo -e "set +e\ntrap 'echo \"Dead now!\"' SIGINT SIGTERM\n$1\nzsh -i" > "$tmpfile"
    konsole --profile red --workdir $WORK_DIR -e "zsh $tmpfile" &
    sleep 0.5
}

# pgsql     #  API
# dbwatch   #  COP
# couchdb   #  Node

i3-msg 'workspace " 10 ï„ˆ Dev Services"'

i3-msg 'focus parent'
i3-msg 'split vertical'

# WORK_DIR="$BASE_DIR"
# cd $WORK_DIR
# shellexec "./scripts/serve couchdb"

# WORK_DIR="$BASE_DIR"
# cd $WORK_DIR

konsole --profile red --workdir $WORK_DIR -e "make images-base"

clean_str=''
serve='couchdb pgsql dbwatch'
if [[ $CLEAN ]]; then
    clean_str='make realclean-dbwatch;'
else
    serve="-n $serve "
fi
shellexec "$clean_str ./scripts/serve $serve"

clean_str=''
serve='pipeline'
if [[ $CLEAN ]]; then
    clean_str='make realclean-pipeline;'
else
    serve="-n $serve "
fi
shellexec "$clean_str ./scripts/serve $serve"

# Echosim
WORK_DIR="$BASE_DIR/services/sims/echosim"
cd $WORK_DIR

if [[ -d dc ]]; then
    WORK_DIR="$BASE_DIR"
    cd $WORK_DIR
    shellexec "./scripts/serve sims/echosim"
elif [[ -f echosim.py ]]; then
    shellexec "sudo ./echosim.py --dir tracks"
fi

sleep 1
# Start the rest on the right side
i3-msg 'focus parent'
i3-msg 'split horizontal'

WORK_DIR="$BASE_DIR"
cd $WORK_DIR

serve='api api_v3'
if [[ $CLEAN ]]; then
    clean_str='make realclean-api realclean-api_v3;'
else
    serve="-n $serve"
fi
shellexec "echo 'Cleaning and starting API V2/V3 dev servers'; $clean_str ./scripts/serve $serve"

sleep 1

i3-msg 'split vertical'

WORK_DIR="$BASE_DIR/cop"
cd $WORK_DIR
if [[ $CLEAN ]]; then
    clean_str='yarn yrebuild;'
fi
shellexec "echo 'Starting COP...'; . $HOME/.nvm/nvm.sh; nvm use system; $clean_str yarn start"

WORK_DIR="$BASE_DIR"
cd $WORK_DIR
if [[ $CLEAN ]]; then
    clean_str='rm -fr services/node/node_modules; cd services/node; npm i; cd -; cd services/go; make clean; make; cd -;'
fi
shellexec "echo 'Starting V1 services...'; \
    . $HOME/.nvm/nvm.sh; nvm use bst; $clean_str \
    ./node_modules/.bin/nf start -j Procfile.jeff"
