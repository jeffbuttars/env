#!/bin/bash

CLEAN='true'
SERVICE_LIST='pgsql dbwatch esink api api_v3 pipeline hal'

SERVICE_LIST='pgsql dbwatch esink api api_v3 pipeline hal'

if [[ $1 ]]; then
    if [[ "$1" == '-n' ]]; then
        CLEAN=''
    fi
fi

BASE_DIR="$HOME/Dev/BST/defenseos"
cd "$BASE_DIR"
WORK_DIR="$BASE_DIR"

shellexec ()
{
    tmpfile=$(mktemp)
    echo -e "set +e\ntrap 'echo \"Dead now!\"' SIGINT SIGTERM\n$1\nzsh -i" > "$tmpfile"

    i3-msg 'workspace " 10  Dev Services"'
    konsole --profile red --workdir $WORK_DIR -e "zsh $tmpfile" &
    sleep 0.5
}

clean_services_str ()
{
    if [[ -z $@ ]]; then
        echo "echo 'No services provided to clean_services_str()!'"
        return
    fi

    clean_str='make '

    for service in $1; do
        clean_str="$clean_str realclean-${service}"
    done

    echo "$clean_str;"
}

# pgsql     #  API
# dbwatch   #  COP
# couchdb   #  Node

i3-msg 'workspace " 10  Dev Services"'

i3-msg 'focus parent'
i3-msg 'split vertical'

# WORK_DIR="$BASE_DIR"
# cd $WORK_DIR
# shellexec "./scripts/serve couchdb"

# WORK_DIR="$BASE_DIR"
# cd $WORK_DIR

if [[ $CLEAN ]]; then
    clean_str="sudo -E $(clean_services_str $SERVICE_LIST)"

    tmpfile=$(mktemp)
    echo -e "$clean_str;\n" > "$tmpfile"
    i3-msg 'workspace " 10  Dev Services"'
    konsole --profile red --workdir $WORK_DIR -e "zsh $tmpfile"
fi


tmpfile=$(mktemp)
echo -e "make images-base;\n" > "$tmpfile"
i3-msg 'workspace " 10  Dev Services"'
konsole --profile red --workdir $WORK_DIR -e "zsh $tmpfile"

serve='couchdb pgsql dbwatch'
if [[ -z $CLEAN ]]; then
    serve="-n $serve "
fi
shellexec "$clean_str ./scripts/serve $serve"

sleep 30

serve='esink'
if [[ -z $CLEAN ]]; then
    serve="-n $serve "
fi
shellexec "./scripts/serve $serve"

serve='pipeline hal'
if [[ -z $CLEAN ]]; then
    serve="-n $serve "
fi
shellexec "./scripts/serve $serve"

# Sims: Echoguard, RFAgent
serve='sims/echoguard sims/rfagent'
if [[ -z $CLEAN ]]; then
    serve="-n $serve "
fi
shellexec "./scripts/serve $serve"

sleep 1
# Start the rest on the right side
i3-msg 'focus parent'
i3-msg 'split horizontal'

WORK_DIR="$BASE_DIR"
cd $WORK_DIR

serve='api api_v3'
if [l -z $CLEAN ]]; then
    serve="-n $serve"
fi
shellexec "./scripts/serve $serve"

sleep 1

i3-msg 'split vertical'

WORK_DIR="$BASE_DIR/cop"
cd $WORK_DIR
if [[ $CLEAN ]]; then
    clean_str='yarn yrebuild;'
fi
shellexec "echo 'Starting COP...'; . $HOME/.config/nvm/nvm.sh; nvm use system; $clean_str yarn start"

WORK_DIR="$BASE_DIR"
cd $WORK_DIR
if [[ $CLEAN ]]; then
    clean_str='rm -fr services/node/node_modules; cd services/node; npm i; cd -; cd services/go; make clean; make; cd -;'
fi
shellexec "echo 'Starting V1 services...'; \
    . $HOME/.config/nvm/nvm.sh; nvm use bst; $clean_str \
    sleep 30; ./node_modules/.bin/nf start -j Procfile.jeff"
